#!/usr/bin/env bash
# [MISE] description="Git status"
# [MISE] dir="{{cwd}}"

# Fetch from origin
git fetch origin

# Check if upstream remote exists and fetch from it
if git remote | grep -q '^upstream$'; then
    git fetch upstream
    echo ""

    # Get the default branch (usually main or master)
    DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')

    # Fallback to 'main' if symbolic-ref isn't set
    if [ -z "$DEFAULT_BRANCH" ]; then
        if git rev-parse --verify origin/main &>/dev/null; then
            DEFAULT_BRANCH="main"
        elif git rev-parse --verify origin/master &>/dev/null; then
            DEFAULT_BRANCH="master"
        fi
    fi

    # Compare origin and upstream default branches
    if [ -n "$DEFAULT_BRANCH" ] && git rev-parse --verify "upstream/$DEFAULT_BRANCH" &>/dev/null; then
        BEHIND=$(git rev-list --count "origin/$DEFAULT_BRANCH..upstream/$DEFAULT_BRANCH" 2>/dev/null || echo "0")
        AHEAD=$(git rev-list --count "upstream/$DEFAULT_BRANCH..origin/$DEFAULT_BRANCH" 2>/dev/null || echo "0")

        if [ "$BEHIND" -gt 0 ] || [ "$AHEAD" -gt 0 ]; then
            [ "$BEHIND" -gt 0 ] && echo "origin/$DEFAULT_BRANCH behind upstream/$DEFAULT_BRANCH by $BEHIND commit(s)"
            [ "$AHEAD" -gt 0 ] && echo "origin/$DEFAULT_BRANCH ahead of upstream/$DEFAULT_BRANCH by $AHEAD commit(s)"
        else
            echo "origin/$DEFAULT_BRANCH is up to date with upstream/$DEFAULT_BRANCH"
        fi
        echo ""
    fi
fi

git status
