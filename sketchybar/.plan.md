# Plan: Make Aerospace Event Handling Consistent with Yabai Pattern

## Current Architecture Analysis

### Inconsistency Identified

**Yabai events:** Follow a clean event-driven pattern
```
Yabai → sketchybar --trigger EVENT_NAME → Sketchybar plugin script
```

**Aerospace keyboard shortcuts:** Call scripts directly
```
Aerospace keybind → scripts/new_workspace.sh (no sketchybar involvement)
Aerospace keybind → scripts/smart_move_window.sh (manipulates sketchybar directly)
```

**Aerospace system events:** Use wm helper server (debounced)
```
Aerospace exec-on-workspace-change → wm workspace_changed → wm server → sketchybar --trigger
Aerospace on-focus-changed → sketchybar --trigger aerospace_workspace_change
```

### Why This Is Inconsistent

1. **`new_workspace.sh`** - Pure aerospace operations, no sketchybar interaction
2. **`smart_move_window.sh`** - Complex script that:
   - Manipulates aerospace state (moves windows)
   - Directly manipulates sketchybar items (adds/removes/moves items)
   - Sources sketchybar helpers and uses sketchy_* functions
   - Lines 268-320 directly query and modify sketchybar state

The problem: This bypasses the event system and creates tight coupling between aerospace keybinds and sketchybar internals.

### Ideal Architecture Pattern

All state changes should flow through sketchybar's event system:
```
Trigger (yabai/aerospace/user) → sketchybar --trigger CUSTOM_EVENT → Plugin script handles it
```

## Implementation Plan

### Option 1: Create Custom Sketchybar Events (RECOMMENDED)

**For `new_workspace.sh` functionality:**
1. Create new sketchybar event: `aerospace_new_workspace`
2. Change aerospace keybind from calling script directly to: `sketchybar --trigger aerospace_new_workspace`
3. Subscribe `space_listener` to this event
4. Move logic from `new_workspace.sh` into the plugin handler

**For `smart_move_window.sh` functionality:**
1. Create new sketchybar events: `aerospace_move_window_next` and `aerospace_move_window_prev`
2. Change aerospace keybinds to: `sketchybar --trigger aerospace_move_window_next/prev`
3. Subscribe `space_listener` to these events
4. Move logic from `smart_move_window.sh` into the plugin handler

**Benefits:**
- Consistent event-driven architecture
- All sketchybar state changes handled in one place
- Better separation of concerns
- Easier to debug (all events flow through sketchybar)
- Can leverage existing helpers and patterns

**Drawbacks:**
- Need to refactor existing scripts into plugin code
- More complex initial setup

### Option 2: Use wm Helper Server for Aerospace Keybinds

**Approach:**
1. Add new wm commands: `wm new_workspace` and `wm move_window --dir next/prev`
2. Change aerospace keybinds to call wm binary
3. Let wm server debounce and trigger sketchybar events

**Benefits:**
- Leverages existing wm server infrastructure
- Consistent with workspace_changed pattern
- Debouncing built-in

**Drawbacks:**
- Requires modifying wm binary (it's compiled, need source)
- Adds another layer of indirection
- wm binary may not be part of this dotfiles repo

### Option 3: Minimal Change - Trigger Events from Scripts

**Approach:**
1. Keep scripts mostly as-is
2. Change aerospace keybinds to trigger sketchybar events
3. Have plugin script call the existing scripts

**Benefits:**
- Minimal code changes
- Scripts can still be called independently

**Drawbacks:**
- Still maintains some inconsistency (scripts manipulate sketchybar directly)
- Doesn't fully solve the architecture problem

## Recommended Approach: Option 1

### Changes Required

#### 1. Update `items/aerospace_spaces.sh`
- Add new events: `aerospace_new_workspace`, `aerospace_move_window_next`, `aerospace_move_window_prev`
- Subscribe `space_listener` to these events

#### 2. Update `plugins/aerospace_spaces.sh`
- Add handler for `aerospace_new_workspace` event
- Add handler for `aerospace_move_window_next` and `aerospace_move_window_prev` events
- Move logic from scripts into these handlers

#### 3. Update `plugins/helpers/aerospace.sh`
- Add functions: `aerospace_create_new_workspace()` and `aerospace_smart_move_window(direction)`
- Migrate core logic from scripts

#### 4. Update `aerospace.toml`
- Change `alt-0` from `exec-and-forget .../new_workspace.sh` to `exec-and-forget sketchybar --trigger aerospace_new_workspace`
- Change `alt-shift-left` to `exec-and-forget sketchybar --trigger aerospace_move_window_prev`
- Change `alt-shift-right` to `exec-and-forget sketchybar --trigger aerospace_move_window_next`

#### 5. Archive old scripts
- Move `scripts/new_workspace.sh` and `scripts/smart_move_window.sh` to `scripts/archived/` (keep for reference)
- Keep `scripts/ensure_contiguous_workspaces.sh` as-is (it's a utility used by multiple callers)

### Migration Steps

1. **Phase 1:** Add new events and handlers (parallel with existing scripts)
2. **Phase 2:** Test new event-based approach
3. **Phase 3:** Update aerospace.toml to use new events
4. **Phase 4:** Archive old scripts once verified working

## Questions for User

1. Do you have access to the wm binary source code? (This would enable Option 2 if preferred)
2. Would you prefer a gradual migration (keep both approaches working) or a clean cut-over?
3. Any concerns about moving bash script logic into the plugin handler?
